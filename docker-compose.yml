version: "3.9"

services:
  # ============================================================
  # PostgreSQL 데이터베이스
  # ============================================================
  db:
    image: postgres:15
    container_name: caf_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: caffeineapprds
      POSTGRES_DB: caffeine_db
    ports:
      - "5432:5432"
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 5s
      timeout: 5s
      retries: 5

  # ============================================================
  # FastAPI 백엔드
  # ============================================================
  backend:
    build: ./10_backend
    container_name: caf_backend
    depends_on:
      db:
        condition: service_healthy
    environment:
      # 2025-12-11: AWS RDS 우선, 연결 실패 시 로컬 DB 폴백
      DB_HOST: caffeine-database.c58og6ke6t36.ap-northeast-2.rds.amazonaws.com
      DB_USER: postgres
      DB_PASSWORD: caffeineapprds
      DB_PORT: 5432
      DB_NAME: postgres
      # Fallback: Local PostgreSQL (Docker 컨테이너)
      LOCAL_DB_HOST: db
      LOCAL_DB_PORT: 5432
      LOCAL_DB_NAME: caffeine_db
      LOCAL_DB_USER: postgres
      LOCAL_DB_PASSWORD: caffeineapprds
      # App
      SECRET_KEY: your-super-secret-key-change-in-production
      # Gmail SMTP
      GMAIL_ADDRESS: ${GMAIL_ADDRESS}
      GMAIL_APP_PASSWORD: ${GMAIL_APP_PASSWORD}
    ports:
      - "8001:8000"
    volumes:
      - ./10_backend/app:/app/app # 핫 리로드용

  # ============================================================
  # 프론트엔드 (관리자)
  # ============================================================
  admin_front:
    build: ./21_frontend_admin
    container_name: caf_front_admin
    ports:
      - "3001:3000"
    environment:
      NEXT_PUBLIC_API_URL: http://localhost
    depends_on:
      - backend

  # ============================================================
  # Nginx (리버스 프록시)
  # ============================================================
  nginx:
    build: ./30_nginx
    container_name: caf_nginx
    ports:
      - "80:80"
    depends_on:
      - backend

  # ============================================================
  # ML 서비스
  # ============================================================
  ml_next:
    build: ./40_ml_next
    container_name: caf_ml_next
    ports:
      - "9001:9001"
    volumes:
      - ./10_backend/app/model_xgboost_acc_73.47.joblib:/app/model.joblib:ro
    environment:
      LOCAL_MODEL_PATH: /app/model.joblib

  # ============================================================
  # LLM 서비스
  # ============================================================
  llm_analysis:
    build: ./51_llm_analysis
    container_name: caf_llm_analysis
    ports:
      - "9102:9102"
    environment:
      GEMINI_API_KEY: ${GEMINI_API_KEY}
