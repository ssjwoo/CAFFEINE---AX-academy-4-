# 병합 이후 변경사항 정리 (상세)
# 작성일: 2025-12-20
# 병합 출처: https://github.com/HosikYOON/caffeine/tree/develop
# 기준 커밋: source_repo/main (9176546)

================================================================================
## 커밋 히스토리 (병합 이후 → 최신순)
================================================================================

1. 1635595 - feat: fix coupon generation and text node bug (2025-12-17)
2. 2b8be78 - Merge develop into main - resolve conflicts (2025-12-17)
3. d71d108 - fix: resolve import order in ml.py for prediction API (2025-12-17)
4. 88af931 - feat: Implement transaction add/delete features and chatbot updates (2025-12-17)
5. 829d204 - 금일 수정사항: LLM 이모지 제거, 대시보드 월별 집계 등 (2025-12-19)

================================================================================
## 1. 커밋 1635595: 쿠폰 생성 및 텍스트 노드 버그 수정
================================================================================
날짜: 2025-12-17 13:16:40

### 변경 파일
[A] 10_backend/app/routers/coupons.py        (+394줄, 신규 생성)
[M] 20_frontend_user/src/screens/CouponScreen.js  (수정)

### 상세 변경 내용

#### coupons.py (백엔드 쿠폰 라우터 - 신규)
- 쿠폰 CRUD API 전체 구현함
- GET /coupons - 사용자 쿠폰 목록 조회 기능 추가함
- POST /coupons/issue - AI 예측 기반 쿠폰 발급 기능 추가함
- POST /coupons/{id}/use - 쿠폰 사용 처리 기능 추가함
- DELETE /coupons - 사용자 쿠폰 일괄 삭제 기능 추가함
- get_current_user_id() 함수로 JWT 토큰 기반 사용자 인증 처리함
- 쿠폰 발급 조건 로직 구현함 (거래 금액, 카테고리 기반)

#### CouponScreen.js (프론트엔드 쿠폰 화면)
- 텍스트 노드 렌더링 버그 수정함
- React Native에서 문자열이 Text 컴포넌트 외부에 있던 문제 해결함

================================================================================
## 2. 커밋 2b8be78: develop 브랜치 병합 및 충돌 해결
================================================================================
날짜: 2025-12-17 14:20:39
병합: 9176546 ← 1635595

### 변경 파일
[M] 10_backend/app/routers/coupons.py        (+33줄)
[M] 20_frontend_user/src/screens/CouponScreen.js  (수정)

### 상세 변경 내용
- HosikYOON/caffeine develop 브랜치와 15tkdgns/caffeine main 브랜치 병합함
- coupons.py에서 발생한 충돌 해결함
- CouponScreen.js에서 발생한 충돌 해결함

================================================================================
## 3. 커밋 d71d108: ML 라우터 import 순서 수정
================================================================================
날짜: 2025-12-17 14:41:32

### 변경 파일
[M] 10_backend/app/routers/ml.py        (+4줄, -5줄)

### 상세 변경 내용
- prediction API 호출 시 발생하던 import 오류 수정함
- 모듈 import 순서를 재배치하여 순환 참조 문제 해결함
- XGBoost 모델 로딩 관련 코드 정리함

================================================================================
## 4. 커밋 88af931: 거래 추가/삭제 기능 및 챗봇 업데이트
================================================================================
날짜: 2025-12-17

### 변경 파일
[M] .gitignore
[M] 10_backend/app/routers/chatbot.py
[A] 10_backend/app/routers/chatbot_backup.py     (신규, 백업용)
[A] 10_backend/app/routers/chatbot_new.py        (신규, 테스트용)
[M] 10_backend/app/routers/transactions.py
[M] 20_frontend_user/src/api/transactions.js
[M] 20_frontend_user/src/contexts/TransactionContext.js
[M] 20_frontend_user/src/screens/TransactionScreen.js
[M] docker-compose.yml
[A] todo.txt                                      (신규)
[D] postgres_data/*                               (1200+ 파일 삭제)

### 상세 변경 내용

#### transactions.py (백엔드 거래 라우터)
- POST /api/transactions 엔드포인트 추가함 (단일 거래 생성)
- DELETE /api/transactions/{id} 엔드포인트 추가함 (거래 삭제)
- TransactionCreate Pydantic 스키마 정의함
- get_current_user_id() 함수로 JWT 인증 처리함
- 거래 생성 시 카테고리 자동 매핑 로직 추가함

#### transactions.js (프론트엔드 API 클라이언트)
- createTransaction() 함수 추가함
- deleteTransaction() 함수 추가함

#### TransactionContext.js (프론트엔드 Context)
- addTransaction() 함수 추가함
- removeTransaction() 함수 추가함
- 로컬 상태와 백엔드 동기화 로직 구현함

#### TransactionScreen.js (프론트엔드 거래 화면)
- 거래 삭제 버튼 및 확인 모달 추가함
- 삭제 성공/실패 피드백 토스트 추가함

#### chatbot.py (백엔드 챗봇)
- 프롬프트 간소화함 (기존 상세 설명 → 짧은 가이드)
- 소비내역 컨텍스트 주입 기능 유지함

#### .gitignore
- postgres_data/ 폴더 추가하여 DB 파일 Git 추적 제외함

#### postgres_data 폴더 삭제
- 로컬 PostgreSQL 데이터 파일들 Git에서 제거함 (1200+ 파일)
- AWS RDS 사용으로 로컬 DB 불필요함

================================================================================
## 5. 커밋 829d204: LLM 및 UI 대규모 업데이트 (develop-psh)
================================================================================
날짜: 2025-12-19 12:25:25
브랜치: develop-psh

### 변경 파일
[M] 20_frontend_user/App.js
[A] 20_frontend_user/src/api/chatbot.js              (신규)
[M] 20_frontend_user/src/api/index.js
[M] 20_frontend_user/src/components/AddTransactionModal.js
[A] 20_frontend_user/src/contexts/AISettingsContext.js    (신규)
[A] 20_frontend_user/src/contexts/ToastContext.js         (신규)
[M] 20_frontend_user/src/contexts/TransactionContext.js
[A] 20_frontend_user/src/hooks/useChatbot.js              (신규)
[M] 20_frontend_user/src/screens/DashboardScreen.js
[M] 20_frontend_user/src/screens/MoreScreen.js
[M] 20_frontend_user/src/screens/ProfileScreen.js
[M] 20_frontend_user/src/screens/TransactionScreen.js
[A] 20_frontend_user/src/utils/spendingAnalyzer.js        (신규)
[M] 51_llm_analysis/app.py
[M] docker-compose.yml

### 상세 변경 내용

#### App.js (메인 앱 컴포넌트)
- Provider 구조 변경함
- AISettingsProvider, ToastProvider 추가 필요했으나 누락됨
- 이후 세션에서 수정함

#### chatbot.js (신규 - 챗봇 API 클라이언트)
- evaluateTransaction() 함수 추가함 - 거래 평가 요청
- getChatResponse() 함수 추가함 - 일반 대화 요청
- 백엔드 /api/chat 엔드포인트와 통신함

#### AISettingsContext.js (신규 - AI 설정 Context)
- aiEnabled 상태 관리함
- toggleAI() 함수로 AI 기능 on/off 전환함
- AsyncStorage에 설정 영속화함
- 거래 추가 시 AI 평가 여부 결정에 사용됨

#### ToastContext.js (신규 - 토스트 알림 Context)
- showToast() 함수로 알림 표시함
- 토스트 메시지 큐 관리함
- 자동 사라짐 타이머 구현함
- success, error, info 타입 지원함

#### useChatbot.js (신규 - 챗봇 React 훅)
- useAISettings Context 사용함
- 거래 평가 로직 캡슐화함
- 로딩 상태, 에러 상태 관리함

#### spendingAnalyzer.js (신규 - 지출 분석 유틸리티)
- 카테고리별 지출 집계 함수 추가함
- 월별 지출 트렌드 분석 함수 추가함
- 이상 지출 감지 로직 추가함

#### DashboardScreen.js (대시보드 화면)
- 월별 지출 집계 섹션 추가함
- "잠깐만 AI" 섹션 추가함 - AI 피드백 표시
- 최근 거래 요약 표시함

#### TransactionScreen.js (거래 화면)
- 거래 삭제 버튼 UI 수정함
- web 환경에서 window.confirm() 사용하도록 변경함
- 삭제 확인 로직 개선함

#### AddTransactionModal.js (거래 추가 모달)
- AI 평가 결과 표시 로직 추가함
- 저장 후 토스트 알림 표시함

#### 51_llm_analysis/app.py (LLM 분석 서비스)
- 이모지 제거 후처리 추가함
- 응답 포맷 정리함
- 프롬프트 튜닝함

#### docker-compose.yml
- 서비스 구성 정리함
- 환경 변수 업데이트함

================================================================================
## 6. 금일 세션 변경사항 (2025-12-20, Git 미커밋)
================================================================================

### 프론트엔드 빈 화면 문제 해결

#### App.js 수정
- AISettingsProvider import 및 추가함
- ToastProvider import 및 추가함
- TransactionContext가 위 두 Context에 의존하므로 Provider 순서 중요함
- SplashScreen.preventAutoHideAsync() 호출 주석 처리함
- Feather 아이콘을 이모지로 대체함 (웹 호환성)
- useFonts 훅 관련 코드 제거함

#### TransactionScreen.js 수정
- ScrollView import 누락되어 있어서 추가함
- 거래내역 탭 진입 시 crash 발생하던 문제 해결함

#### index.html 삭제
- 프로젝트 루트의 Vite용 index.html이 Expo Web과 충돌함
- 삭제하여 Expo가 web/index.html 사용하도록 함

### API 경로 문제 해결

#### coupons.js 수정
- API 경로 /api/coupons → /coupons 로 변경함
- 백엔드 coupons.py의 prefix가 /coupons이므로 맞춤
- 404 Not Found 오류 해결됨 (401 Unauthorized는 인증 필요한 정상 동작)

### Docker 관련
- docker compose build --no-cache backend 실행하여 이미지 재빌드함
- docker compose up -d --force-recreate backend로 컨테이너 재생성함
- WSL 재시작 후 API 정상 작동 확인함

### 기능 테스트 결과
- 거래 추가: 정상 작동 확인함 (BrowserTest 12,345원 추가됨)
- 거래 삭제: 정상 작동 확인함 (3545건 → 3544건)
- AI 피드백: 정상 작동 확인함 (거래 추가 시 분석 메시지 표시됨)
- 챗봇 알림: 정상 작동 확인함 (대시보드 "잠깐만 AI" 섹션)

### 챗봇 프롬프트
- chatbot.py 프롬프트 사용자 직접 수정 중임

================================================================================
## 전체 변경 파일 목록 (신규 및 주요 수정)
================================================================================

### 백엔드 (10_backend)
| 파일 | 상태 | 설명 |
|------|------|------|
| app/routers/coupons.py | 신규 | 쿠폰 CRUD API 전체 (+394줄) |
| app/routers/transactions.py | 수정 | 거래 추가/삭제 API 추가 |
| app/routers/chatbot.py | 수정 | 프롬프트 간소화, 컨텍스트 주입 |
| app/routers/chatbot_backup.py | 신규 | 백업용 (미사용) |
| app/routers/chatbot_new.py | 신규 | 테스트용 (미사용) |
| app/routers/ml.py | 수정 | import 순서 수정 |

### 프론트엔드 (20_frontend_user)
| 파일 | 상태 | 설명 |
|------|------|------|
| App.js | 수정 | Provider 추가, 아이콘 변경 |
| src/api/chatbot.js | 신규 | 챗봇 API 클라이언트 (+132줄) |
| src/api/transactions.js | 수정 | create/delete 함수 추가 |
| src/api/coupons.js | 수정 | API 경로 변경 |
| src/contexts/AISettingsContext.js | 신규 | AI on/off 설정 (+52줄) |
| src/contexts/ToastContext.js | 신규 | 토스트 알림 관리 (+142줄) |
| src/contexts/TransactionContext.js | 수정 | add/remove 함수 추가 |
| src/hooks/useChatbot.js | 신규 | 챗봇 훅 (+154줄) |
| src/utils/spendingAnalyzer.js | 신규 | 지출 분석 유틸 (+111줄) |
| src/screens/DashboardScreen.js | 수정 | 월별 집계, AI 섹션 추가 |
| src/screens/TransactionScreen.js | 수정 | 삭제 버튼, ScrollView 추가 |
| src/screens/CouponScreen.js | 수정 | 텍스트 노드 버그 수정 |
| src/components/AddTransactionModal.js | 수정 | AI 평가 표시 |
| index.html | 삭제 | Expo 충돌 해결 |

### LLM 서비스 (51_llm_analysis)
| 파일 | 상태 | 설명 |
|------|------|------|
| app.py | 수정 | 이모지 제거, 프롬프트 튜닝 (+383줄 수정) |

### 기타
| 파일 | 상태 | 설명 |
|------|------|------|
| docker-compose.yml | 수정 | 서비스 구성 정리 |
| .gitignore | 수정 | postgres_data 추가 |
| todo.txt | 신규 | 작업 목록 |
| postgres_data/* | 삭제 | 로컬 DB 파일 제거 (1200+ 파일) |
