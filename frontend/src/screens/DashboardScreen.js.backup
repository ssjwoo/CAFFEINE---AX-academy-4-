import React, { useState, useEffect, useRef } from 'react';
import { View, Text, ScrollView, StyleSheet, Dimensions, RefreshControl, TouchableOpacity } from 'react-native';
import { LineChart, PieChart } from 'react-native-chart-kit';
import { useTheme } from '../contexts/ThemeContext';
import CountUpNumber from '../components/CountUpNumber';
import FadeInView from '../components/FadeInView';
import AnimatedButton from '../components/AnimatedButton';
import { SkeletonStats, SkeletonChart } from '../components/SkeletonCard';
import { formatCurrency } from '../utils/currency';
import { CHART_COLORS, ANIMATION_DELAY } from '../constants';

const MOCK_DATA = {
    summary: { total_spending: 1250000, total_transactions: 81, average_transaction: 15432, most_used_category: 'ì‡¼í•‘', monthly_trend: 'ì¦ê°€', anomaly_count: 3 },
    monthlyData: [
        { month: '2024-06', total_amount: 577000 },
        { month: '2024-07', total_amount: 638000 },
        { month: '2024-08', total_amount: 705200 },
        { month: '2024-09', total_amount: 633800 },
        { month: '2024-10', total_amount: 761200 },
        { month: '2024-11', total_amount: 185000 },
    ],
    categoryData: [
        { category: 'ì‡¼í•‘', total_amount: 1140000, percentage: 37 },
        { category: 'ì‹ë¹„', total_amount: 890000, percentage: 29 },
        { category: 'ê³µê³¼ê¸ˆ', total_amount: 590000, percentage: 19 },
        { category: 'ì—¬ê°€', total_amount: 280000, percentage: 9 },
        { category: 'êµí†µ', total_amount: 125000, percentage: 4 },
        { category: 'ê¸°íƒ€', total_amount: 75000, percentage: 2 },
    ]
};

export default function DashboardScreen({ navigation }) {
    const { colors } = useTheme();
    const [loading, setLoading] = useState(true);
    const [refreshing, setRefreshing] = useState(false);
    const [summary, setSummary] = useState(null);
    const [monthlyData, setMonthlyData] = useState([]);
    const [categoryData, setCategoryData] = useState([]);
    const [tooltip, setTooltip] = useState(null); // í„°ì¹˜ ì‹œ í‘œì‹œë  íˆ´íŒ

    const scrollViewRef = useRef(null);
    const categoryRef = useRef(null);
    const insightRef = useRef(null);

    const loadData = async () => {
        try {
            setSummary(MOCK_DATA.summary);
            setMonthlyData(MOCK_DATA.monthlyData);
            setCategoryData(MOCK_DATA.categoryData);
        } finally {
            setLoading(false);
            setRefreshing(false);
        }
    };

    useEffect(() => { loadData(); }, []);

    const onRefresh = () => {
        setRefreshing(true);
        loadData();
    };

    const handleTotalSpendingClick = () => {
        categoryRef.current?.measure((x, y, width, height, pageX, pageY) => {
            scrollViewRef.current?.scrollTo({ y: pageY - 100, animated: true });
        });
    };

    const handleTransactionCountClick = () => {
        navigation?.navigate('ê±°ë˜ë‚´ì—­');
    };

    const handleAverageTransactionClick = () => {
        insightRef.current?.measure((x, y, width, height, pageX, pageY) => {
            scrollViewRef.current?.scrollTo({ y: pageY - 100, animated: true });
        });
    };

    if (loading) {
        return (
            <ScrollView style={styles(colors).container}>
                <View style={styles(colors).summarySection}>
                    <Text style={styles(colors).sectionTitle}>ğŸ’° ì´ë²ˆ ë‹¬ ì†Œë¹„ ìš”ì•½</Text>
                    <SkeletonStats />
                    <SkeletonStats />
                    <SkeletonStats />
                </View>
                <View style={styles(colors).chartSection}>
                    <Text style={styles(colors).sectionTitle}>ğŸ“Š ì›”ë³„ ì§€ì¶œ ì¶”ì´</Text>
                    <SkeletonChart />
                </View>
                <View style={styles(colors).chartSection}>
                    <Text style={styles(colors).sectionTitle}>ğŸ¥§ ì¹´í…Œê³ ë¦¬ë³„ ì†Œë¹„</Text>
                    <SkeletonChart />
                </View>
            </ScrollView>
        );
    }

    const screenWidth = Dimensions.get('window').width;
    const chartWidth = screenWidth - 40;

    const lineChartData = {
        labels: monthlyData.map(item => item.month.split('-')[1] + 'ì›”'),
        datasets: [{
            data: monthlyData.map(item => item.total_amount / 1000000),
            color: (opacity = 1) => colors.primary.replace('rgb', 'rgba').replace(')', `, ${opacity})`),
            strokeWidth: 2
        }]
    };

    const pieChartData = categoryData.map((item, index) => ({
        name: item.category,
        population: item.total_amount,
        color: CHART_COLORS[index % CHART_COLORS.length],
        legendFontColor: colors.text,
        legendFontSize: 12
    }));

    return (
        <ScrollView ref={scrollViewRef} style={styles(colors).container}
            refreshControl={<RefreshControl refreshing={refreshing} onRefresh={onRefresh} />}>

            <FadeInView style={styles(colors).summarySection} delay={ANIMATION_DELAY.NONE}>
                <Text style={styles(colors).sectionTitle}>ğŸ’° ì´ë²ˆ ë‹¬ ì†Œë¹„ ìš”ì•½</Text>
                <View style={styles(colors).summaryGrid}>
                    <AnimatedButton style={[styles(colors).summaryCard, styles(colors).mainCard]}
                        onPress={handleTotalSpendingClick}>
                        <Text style={styles(colors).summaryLabel}>ì´ ì§€ì¶œ</Text>
                        <CountUpNumber
                            value={summary?.total_spending || 0}
                            formatter={(num) => formatCurrency(num)}
                            style={styles(colors).summaryValueLarge}
                            duration={1200}
                        />
                        <Text style={styles(colors).summaryTrend}>
                            {summary?.monthly_trend === 'ì¦ê°€' ? 'ğŸ“ˆ ì§€ë‚œë‹¬ ëŒ€ë¹„ ì¦ê°€' : 'ğŸ“‰ ì§€ë‚œë‹¬ ëŒ€ë¹„ ê°ì†Œ'}
                        </Text>
                        <Text style={styles(colors).clickHint}>íƒ­í•˜ì—¬ ì¹´í…Œê³ ë¦¬ ë³´ê¸°</Text>
                    </AnimatedButton>

                    <AnimatedButton style={styles(colors).summaryCard}
                        onPress={handleTransactionCountClick}>
                        <Text style={styles(colors).summaryLabel}>ê±°ë˜ ê±´ìˆ˜</Text>
                        <CountUpNumber
                            value={summary?.total_transactions || 0}
                            formatter={(num) => num + 'ê±´'}
                            style={styles(colors).summaryValue}
                            duration={1000}
                        />
                        <Text style={styles(colors).clickHint}>íƒ­í•˜ì—¬ ê±°ë˜ë‚´ì—­ ë³´ê¸°</Text>
                    </AnimatedButton>

                    <AnimatedButton style={styles(colors).summaryCard}
                        onPress={handleAverageTransactionClick}>
                        <Text style={styles(colors).summaryLabel}>í‰ê·  ê±°ë˜ì•¡</Text>
                        <CountUpNumber
                            value={summary?.average_transaction || 0}
                            formatter={(num) => formatCurrency(num)}
                            style={styles(colors).summaryValue}
                            duration={1000}
                        />
                        <Text style={styles(colors).clickHint}>íƒ­í•˜ì—¬ ì¸ì‚¬ì´íŠ¸ ë³´ê¸°</Text>
                    </AnimatedButton>
                </View>

                {summary?.anomaly_count > 0 && (
                    <TouchableOpacity style={styles(colors).alertCard}>
                        <Text style={styles(colors).alertIcon}>âš ï¸</Text>
                        <View style={styles(colors).alertContent}>
                            <Text style={styles(colors).alertTitle}>ì˜ì‹¬ ê±°ë˜ ë°œê²¬</Text>
                            <Text style={styles(colors).alertText}>{summary.anomaly_count}ê±´ì˜ ì´ìƒ ê±°ë˜ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</Text>
                        </View>
                    </TouchableOpacity>
                )}
            </FadeInView>

            <FadeInView style={styles(colors).chartSection} delay={ANIMATION_DELAY.MEDIUM}>
                <Text style={styles(colors).sectionTitle}>ğŸ“Š ì›”ë³„ ì§€ì¶œ ì¶”ì´</Text>
                <View>
                    <LineChart
                        data={lineChartData}
                        width={chartWidth}
                        height={220}
                        chartConfig={{
                            backgroundColor: colors.cardBackground,
                            backgroundGradientFrom: colors.cardBackground,
                            backgroundGradientTo: colors.cardBackground,
                            decimalPlaces: 1,
                            color: (opacity = 1) => colors.primary.replace('rgb', 'rgba').replace(')', `, ${opacity})`),
                            labelColor: (opacity = 1) => colors.text.replace('rgb', 'rgba').replace(')', `, ${opacity})`),
                            style: { borderRadius: 16 },
                            propsForDots: { r: '6', strokeWidth: '2', stroke: colors.primary }
                        }}
                        bezier
                        style={styles(colors).chart}
                        onDataPointClick={(data) => {
                            const amount = (data.value * 1000000).toFixed(0);
                            setTooltip({
                                x: data.x,
                                y: data.y,
                                value: formatCurrency(parseInt(amount)),
                                month: monthlyData[data.index]?.month.split('-')[1] + 'ì›”'
                            });
                            setTimeout(() => setTooltip(null), 3000);
                        }}
                    />
                    {tooltip && (
                        <View style={[styles(colors).tooltip, { left: tooltip.x - 40, top: tooltip.y - 50 }]}>
                            <Text style={styles(colors).tooltipMonth}>{tooltip.month}</Text>
                            <Text style={styles(colors).tooltipValue}>{tooltip.value}</Text>
                        </View>
                    )}
                </View>
                <Text style={styles(colors).chartCaption}>ë‹¨ìœ„: ë°±ë§Œì›</Text>
            </FadeInView>

            <FadeInView ref={categoryRef} style={styles(colors).chartSection} delay={ANIMATION_DELAY.LONG}>
                <Text style={styles(colors).sectionTitle}>ğŸ¥§ ì¹´í…Œê³ ë¦¬ë³„ ì†Œë¹„</Text>
                <View>
                    <PieChart
                        data={pieChartData}
                        width={chartWidth}
                        height={220}
                        chartConfig={{
                            color: (opacity = 1) => `rgba(0, 0, 0, ${opacity})`
                        }}
                        accessor="population"
                        backgroundColor="transparent"
                        paddingLeft="15"
                        absolute
                        hasLegend={false}
                    />
                    {tooltip && tooltip.type === 'pie' && (
                        <View style={[styles(colors).tooltip, { left: tooltip.x || chartWidth / 2 - 60, top: tooltip.y || 100 }]}>
                            <Text style={styles(colors).tooltipMonth}>{tooltip.category}</Text>
                            <Text style={styles(colors).tooltipValue}>{tooltip.value}</Text>
                            <Text style={styles(colors).tooltipPercent}>{tooltip.percent}</Text>
                        </View>
                    )}
                </View>

                <View style={styles(colors).categoryList}>
                    {categoryData.map((item, index) => (
                        <TouchableOpacity
                            key={index}
                            style={styles(colors).categoryItem}
                            onPress={() => {
                                setTooltip({
                                    type: 'pie',
                                    category: item.category,
                                    value: formatCurrency(item.total_amount),
                                    percent: `${item.percentage}%`,
                                    x: chartWidth / 2 - 60,
                                    y: 100
                                });
                                setTimeout(() => setTooltip(null), 3000);
                            }}
                        >
                            <View style={styles(colors).categoryInfo}>
                                <View style={[styles(colors).categoryDot, { backgroundColor: CHART_COLORS[index % CHART_COLORS.length] }]} />
                                <Text style={styles(colors).categoryName}>{item.category}</Text>
                            </View>
                            <View style={styles(colors).categoryAmount}>
                                <Text style={styles(colors).categoryValue}>{formatCurrency(item.total_amount)}</Text>
                                <Text style={styles(colors).categoryPercent}>({item.percentage}%)</Text>
                            </View>
                        </TouchableOpacity>
                    ))}
                </View>
            </FadeInView>

            <FadeInView ref={insightRef} style={styles(colors).insightSection} delay={ANIMATION_DELAY.VERY_LONG}>
                <Text style={styles(colors).sectionTitle}>ğŸ’¡ AI ì¸ì‚¬ì´íŠ¸</Text>

                <View style={styles(colors).insightCard}>
                    <Text style={styles(colors).insightIcon}>ğŸ”</Text>
                    <Text style={styles(colors).insightText}>
                        ì´ë²ˆ ë‹¬ <Text style={styles(colors).insightHighlight}>{summary?.most_used_category}</Text>ì— ê°€ì¥ ë§ì´ ì§€ì¶œí–ˆì–´ìš”
                    </Text>
                </View>

                <View style={styles(colors).insightCard}>
                    <Text style={styles(colors).insightIcon}>ğŸ’¸</Text>
                    <Text style={styles(colors).insightText}>
                        í‰ê·  ê±°ë˜ì•¡ì€ <Text style={styles(colors).insightHighlight}>{summary?.average_transaction.toLocaleString()}ì›</Text>ìœ¼ë¡œ,
                        ì§€ë‚œ 6ê°œì›” í‰ê·  ëŒ€ë¹„ <Text style={styles(colors).insightHighlight}>12%</Text> ì¦ê°€í–ˆì–´ìš”
                    </Text>
                </View>
            </FadeInView>

            <View style={{ height: 40 }} />
        </ScrollView>
    );
}

const styles = (colors) => StyleSheet.create({
    container: { flex: 1, backgroundColor: colors.background },
    summarySection: { padding: 20 },
    sectionTitle: { fontSize: 18, fontWeight: 'bold', color: colors.text, marginBottom: 16 },
    summaryGrid: { gap: 12 },
    summaryCard: { backgroundColor: colors.cardBackground, borderRadius: 12, padding: 16, borderWidth: 1, borderColor: colors.border },
    mainCard: { borderColor: colors.primary, borderWidth: 2 },
    summaryLabel: { fontSize: 14, color: colors.textSecondary, marginBottom: 8 },
    summaryValue: { fontSize: 24, fontWeight: 'bold', color: colors.text },
    summaryValueLarge: { fontSize: 32, fontWeight: 'bold', color: colors.primary, marginBottom: 8 },
    summaryTrend: { fontSize: 12, color: colors.textSecondary },
    clickHint: { fontSize: 11, color: colors.primary, marginTop: 8, opacity: 0.8 },
    alertCard: { marginTop: 16, backgroundColor: colors.warningBackground, borderRadius: 12, padding: 16, flexDirection: 'row', alignItems: 'center' },
    alertIcon: { fontSize: 32, marginRight: 12 },
    alertContent: { flex: 1 },
    alertTitle: { fontSize: 16, fontWeight: 'bold', color: colors.warning, marginBottom: 4 },
    alertText: { fontSize: 14, color: colors.text },
    chartSection: { padding: 20, backgroundColor: colors.cardBackground, marginBottom: 12 },
    chart: { marginVertical: 8, borderRadius: 16 },
    chartCaption: { fontSize: 12, color: colors.textSecondary, textAlign: 'center', marginTop: 8 },
    categoryList: { marginTop: 16 },
    categoryItem: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', paddingVertical: 12, borderBottomWidth: 1, borderBottomColor: colors.border },
    categoryInfo: { flexDirection: 'row', alignItems: 'center' },
    categoryDot: { width: 12, height: 12, borderRadius: 6, marginRight: 12 },
    categoryName: { fontSize: 14, color: colors.text },
    categoryAmount: { alignItems: 'flex-end' },
    categoryValue: { fontSize: 14, fontWeight: 'bold', color: colors.text },
    categoryPercent: { fontSize: 12, color: colors.textSecondary },
    insightSection: { padding: 20 },
    insightCard: { backgroundColor: colors.cardBackground, borderRadius: 12, padding: 16, marginBottom: 12, flexDirection: 'row', alignItems: 'center', borderWidth: 1, borderColor: colors.border },
    insightIcon: { fontSize: 32, marginRight: 16 },
    insightText: { flex: 1, fontSize: 14, color: colors.text, lineHeight: 20 },
    insightHighlight: { fontWeight: 'bold', color: colors.primary },

    // Tooltip styles
    tooltip: {
        position: 'absolute',
        backgroundColor: colors.primary,
        borderRadius: 6,
        padding: 8,
        paddingHorizontal: 12,
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.25,
        shadowRadius: 3.84,
        elevation: 5,
        zIndex: 1000
    },
    tooltipMonth: {
        fontSize: 10,
        color: '#fff',
        fontWeight: '600',
        marginBottom: 2
    },
    tooltipValue: {
        fontSize: 12,
        color: '#fff',
        fontWeight: 'bold'
    },
    tooltipPercent: {
        fontSize: 10,
        color: '#fff',
        opacity: 0.9,
        marginTop: 2
    },
});
